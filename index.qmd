---
title: ESS 330 Project Proposals
authors: 
  - name: Sarah Culhane
    affiliation: Colorado State University
    corresponding: true
  - name: Archer Goodman
    affiliation: Colorado State University
  - name: McKenna Cooper
    affiliation: Colorado State University
bibliography: references.bib
---

# Proposal 1

**Title:** Testing for a relationship between migratory shorebird abundance during stopovers at wetland habitats and anthropogenic externalities on local-scale wetland conditions.

**Justification:** Wetlands provide critical stopover habitat for many migratory bird species to rest and replenish energy reserves needed for them to complete their migration. In the Northern Great plains, wetlands are particularly important for migratory shorebirds, providing stopover for birds that breed in northern parts of the Great Plains, the boreal forest, and Arctic tundra. However, the Great Plains has experienced a large amount of wetland loss from numerous anthropogenic factors, with agricultural conversion having the largest impact [@elmore2024]. Currently, shorebird populations are declining, and while this is a widespread phenomenon, migratory species, most of which breed in the arctic and subarctic regions during the boreal summer and migrate to to temporal and tropical areas during the non-breeding season, are being hit harder than most (@colwell2010shorebird). The ultimate cause of this is unknown, but what is known is that humans have expanded their use of coastal ecosystems in recent years, impacting shorebirds in numerous ways, such as the claiming of intertidal and supratidal spaces. (@santos2023global), warranting more research on the impact of anthropogenic externalities on shorebird abundance.

**Research Objective/question/hypothesis:** In this study, I aim to test the hypothesis that there is a relationship between local anthropogenic forces surrounding wetlands in the Northern Great Plains and the abundance of migratory shorebird species within those wetlands.

**Proposed Methods:** To carry out this study, I plan to use data from “Associations with landscape and local-scale wetland habitat conditions vary among migratory shorebird species during stopovers”. For this study, researchers used shorebird abundance data for 16 different shorebird species by collecting surveys on wetlands during spring and fall migration from fall 2007 to spring 2009 in ten counties in north-central Oklahoma, USA, which was published to dryad. Their goal was to identify and compare the associate of observed abundance and with within-wetland characteristics to gain a better understanding of habitat requirement. For this project, I plan to cut down the data to just the year 2009 and use surrounding wetland characteristics (surrounding slope surrounding habitat, land context, ect). The data set includes individual species abundance, total migrating shorebirds (i.e., excluding locally breeding species) abundance, and shorebird abundance. I plan to look at only shorebird abundance to make things easier. For variables that have numerical data, I plan to use a t-test to compare the means, seeing if I can predict whether any predictor variables are statistically significant. Additionally, I plan on using the chi-squared to test to determine if any predictor variables are independent of shorebird abundance.

**Expected Outcomes:** I expect that there will be a negative relationship between anthropogenic forces and shorebird abundance, with shorebird abundance decreasing as surrounding wetland anthropogenic forces, such as cultivation and infrastructure, increases

# Proposal #2

Title: Assessing the influence of riparian zones on taxonomic richness in Crater Lake National Park

Justification: Riparian zones are integral to the health of freshwater ecosystems, providing essential ecosystem services and contributing greatly to their adjacent ecosystems despite representing a narrow portion of the landscape.They are often associated with better watershed health through their ability to buffer pollutants, protect against erosion, and provide habitat for a variety of species, increasing species richness (@Sabo2005). In freshwater ecosystems, benthic macroinvertebrates are frequently used in water quality monitoring as indicators of health, as many species are sensitive to pollution or habitat modification. Because of their tolerance to pollution, the presence and dominance of macroinvertebrates in orders Ephemeroptera (mayflies), Plecoptera (stoneflies), and Trichoptera (caddisflies), often referred to as EPT, generally indicates good water health. The dominance of macroinvertebrates tolerant to pollutants, such as leeches and midge larva, indicates poor water health (@McDonald_Mullins_Lewis_1991). However, riparian zones are constantly being threatened by humans, and the degradation of them could prove harmful to their adjacent ecosystems, in part due to their influence on taxonomic richness, facilitating the need for more research on the area.

Research Objective/question/hypothesis: In this study, I aim to test the influence of riparian zones on macroinvertebrate taxonomic richness and distribution in lakes and ponds at Crater Lake National Park. Intact riparian zones are generally associated with higher macroinvertebrate populations and diversity and healthier waterbodies, and a high abundance of benthic macroinvertebrates orders Ephemeroptera (mayflies), Plecoptera (stoneflies), and Trichoptera (caddisflies). Because of this, I hypothesize that waterbodies with more intact riparian zones will have a higher number of EPT benthic macroinvertebrates than water bodies with less intact riparian zones. 

Proposed methods: For this project, I propose looking at two datasets provided by the Klamath Lakes Monitoring Data Package 2013-2019, which contains monitoring data for lakes and ponds at Crater Lake NP, Lassen Volcanic NP, and Redwood NSP. The datasets I am planning on using are InvertSpecies.csv, which holds data about species detected during invertebrate surveys, and RiparianCover.csv, which holds data about riparian cover at 15 semi equidistant points around the lake. Looking at both datasets, they both have the columns “Unit_Code”, “Park_Name”, “Lake_Code”, and “Start_date”, with a lot of the same information in the columns for both datasets. This, along with the fact that both datasets are part of the same data package and overarching project, tells me that the area that the data was collected was the same for both datasets, with some exceptions where data was collected for one set but not the other. To narrow down the scope, I plan to use just the data from Crater Lake National Park in the year 2018 in both data sets. As for the invertebrate dataset, I plan on filtering the data to just include the columns mentioned before as well as order and life stage, filtering the data to just invertebrates collected in the larva stage with no damage. I plan on cutting the riparian vegetation data to the appropriate columns as well and joining the two datasets, looking at each lake code and performing the appropriate tests to figure out what orders of macroinvertebrates were present in that waterbody and what the riparian cover looked like, drawing conclusions that either prove or disprove my hypothesis.

Expected outcomes: I expect that results will support my hypothesis, disproving the null hypothesis that there is no association between benthic macroinvertebrate taxonomic richness and riparian cover in Crater Lake National Park.

# Proposal #3

**Title:** Double trouble for forests; Can bark beetle countermeasures increase the risk of fire?

**Justification:** The forests of the continental United States are valuable natural resources. Whether they are used for balanced logging or preserved for conservation and recreation, it is in the best interest of the public and the government to preserve these forests and help increase their growth. In recent decades, America’s forests have been endangered on three fronts. In addition to the deforestation threat that most forests of the world face, our forests have also been ravaged by both wildfires and bark beetles for the last several decades. A myriad of practices and policies have been proposed, tested, rejected, and implemented to combat these disturbances (@coops2008investigating, @belanger1993management). Over many years, this has resulted in a relatively complex system of caring for our forests. But has this system, in its complexity, begun to fight itself?

**Research Objective/question/hypothesis:** In this study, we will test whether the presence of bark beetle countermeasures increase the risk of wildfire.

**Proposed methods:** We will use GIS to determine if fire ignition points occurred within areas where bark beetle countermeasures were used, as well as data regarding tree mortality rates from both wildfire and bark beetles.

**Expected outcomes:** We expect to prove that there is no connection between bark beetle practices and wildfire risk

# Proposal #4

**Title:** Is water quality impacted by sea level rise?

**Justification:** As temperatures and sea levels rise, there is increasing risk of erosion and damage to our coastlines. Many efforts have been made to relocate (@mcglashan2003managed) or otherwise protect human life as critical infrastructure erodes. But there may be a danger that extends further inland. Freshwater quality is very important to life, both human and otherwise. The quality of said water can be affected by a frankly astonishing variety of factors, and can be difficult and costly to clean. As sea levels rise, saltwater may be intruding on coastal aquifers (@barlow2010saltwater) and degrading the quality of water available for human use. This project aims to determine if there is any connection between sea level rise and water quality

**Research Objective/question/hypothesis:** Is there a correlation between sea level rise and water quality?

**Proposed Methods:** We will use data on water quality and data on sea level rise to determine if there is a negative correlation between water quality and sea level rise.

**Expected Outcomes:**

-   Identification of any correlation between sea level rise and declining water quality.

-   Evidence of saltwater intrusion into coastal aquifers affecting freshwater resources.

-   Insights into regional variations in water quality impacts.

Findings that may inform future coastal water management and mitigation strategies.

# Proposal # 5

**Title:** Investigating the Correlation Between Bromus tectorum Abundance and Wildfire Frequency in Colorado Rangelands

**Justification:**

The justification for this project lies in the significant ecological impact of Bromus tectorum (cheatgrass) on Colorado’s rangelands, particularly in relation to fire frequency and biodiversity loss. Cheatgrass is an invasive species that alters fire regimes by increasing fire intensity and frequency (@bradley2018cheatgrass). This invasive grass is highly flammable and promotes larger, more frequent wildfires, which further facilitate its spread (@monty2013fire). One major example is the Cameron Peak Fire, which burned over 208,000 acres in 2020, making it the largest wildfire in Colorado history. Cheatgrass has likely contributed to fire intensity in affected areas, and post-fire landscapes are at risk of further cheatgrass invasion, leading to decreased native plant diversity and altered ecosystem dynamics. Understanding the relationship between cheatgrass and fire is crucial for developing effective management strategies that protect biodiversity and mitigate fire risks in Colorado’s rangelands, especially in the case of inevitable future fires.

**Research Objective/question/hypothesis:**

[Objective:]{.underline} Determine whether an increase in cheatgrass abundance is correlated with higher wildfire frequency in Colorado rangelands.

\
[Research Question:]{.underline} How does the presence of cheatgrass influence wildfire occurrence and severity?

\
[Hypothesis:]{.underline} Areas with higher cheatgrass coverage experience more frequent and intense wildfires compared to regions with lower cheatgrass presence.

**Proposed methods:**

-   Use remote sensing data (MODIS/Landsat) to map cheatgrass distribution over time.

-   Obtain wildfire occurrence data from USGS and state fire agencies.

-   Perform spatial analysis to identify correlations between cheatgrass abundance and fire frequency.

-   Use regression modeling to assess whether cheatgrass presence is a significant predictor of wildfire occurrence.

**Expected outcomes:**

-   An understanding of how recent cheatgrass management practices have reduced spread of the species

-   A positive correlation between abundance of Bromus tectorum and frequency and intensity of fires.

# Proposal #6

**Title:** Assessing the Impact of Earlier Snowmelt on Streamflow Patterns in Colorado’s Rocky Mountain Watersheds

**Justification:**

Snowmelt is a primary source of freshwater for ecosystems, agriculture, and urban water supplies in the western United States (@luce2018effects). Due to rising temperatures and changing precipitation patterns, snowmelt is occurring earlier in the year, potentially altering seasonal streamflow dynamics. This shift may lead to lower late-summer water availability, increased drought stress, and disruptions in aquatic ecosystems (@dudley2017trends). In Colorado, where population growth continues to increase water demand, projects like the Thornton Pipeline highlight the challenges of securing long-term water supplies for increasing populations. Earlier snowmelt can reduce late-season river flows, impacting both municipal water supplies and agricultural irrigation. Additionally, reduced snowpack threatens hydropower production and increases reliance on groundwater, which is not a sustainable solution. Understanding how shifting snowmelt patterns affect streamflow is critical for water resource management, flood prevention, and ecosystem conservation, especially as climate change intensifies water scarcity in the region.

**Research Objective/question/hypothesis:**

[Objective:]{.underline} Investigate the relationship between earlier snowmelt timing and streamflow patterns in Colorado’s Rocky Mountain watersheds.\
\
[Research Question:]{.underline} How does the timing of snowmelt impact seasonal streamflow trends in Colorado?\
\
[Hypothesis:]{.underline} Earlier snowmelt results in higher spring streamflow but reduced summer and fall water availability.

**Proposed methods:**

-   Obtain historical snowmelt timing data from SNOTEL and climate datasets.

-   Collect streamflow data from USGS gauging stations in selected Colorado watersheds.

-   Analyze trends in snowmelt timing and streamflow over multiple decades.

-   Use statistical models (e.g., regression analysis) to assess correlations between snowmelt timing and seasonal flow variability.

**Expected outcomes:**

-   A strong relationship between early season snowmelt, snowpack, and late-summer water availability in Colorado.

-   A clearer understanding of how changes in snowmelt timing affect seasonal water availability.

Final report coding stuff

```{r}
# Load Libraries
library(ggplot2)
library(dplyr)
library(tidymodels)
library(parsnip)
library(vegan) # for calculating diversity indices

# Load data
invert_species <- read.csv("InvertSpecies (5).csv")
riparian_cover <- read.csv("RiparianCover (3).csv")
water_quality <- read.csv("WaterQuality (2).csv")

# Filter for Lassen Volcanic National Park and years 2013 and 2019
invert_species_2013 <- invert_species %>%
  filter(Park_Name == "Lassen Volcanic National Park" & 
           (Start_Date >= as.Date("2013-01-01") & 
           Start_Date <= as.Date("2013-12-31")) | 
           (Start_Date >= as.Date("2019-01-01") & 
           Start_Date <= as.Date("2019-12-31")))

riparian_cover_2013 <- riparian_cover %>%
  filter(Park_Name == "Lassen Volcanic National Park" & 
           (Start_Date >= as.Date("2013-01-01") & 
           Start_Date <= as.Date("2013-12-31")) | 
           (Start_Date >= as.Date("2019-01-01") & 
           Start_Date <= as.Date("2019-12-31")))

water_quality_2013 <- water_quality %>%
  filter(Park_Name == "Lassen Volcanic National Park" & 
           (Start_Date >= as.Date("2013-01-01") & 
           Start_Date <= as.Date("2013-12-31")) |
           (Start_Date >= as.Date("2019-01-01") & 
           Start_Date <= as.Date("2019-12-31")))

# Merge datasets
merged_data_2013 <- invert_species_2013 %>%
  inner_join(riparian_cover_2013, by = c("Lake_Code", "Park_Name", "Start_Date")) %>%
  inner_join(water_quality_2013, by = c("Lake_Code", "Park_Name", "Start_Date"))

# Preparing data for diversity metrics calculation
melded_data_2013 <- merged_data_2013 %>%
  mutate(
    Veg_Cover = case_when(
      Barren_AreaCcover == "sparse (<10%)" ~ 0.05,
      Barren_AreaCcover == "moderate (10-40%)" ~ 0.25,
      Barren_AreaCcover == "heavy (40-75%)" ~ 0.57,
      Barren_AreaCcover == "very heavy (>75%)" ~ 0.87),
    Order = as.factor(Order)  # Ensuring 'Order' is treated as a factor
  )

# Prepare for calculating Taxa Richness and Shannon-Wiener Diversity Index
taxa_data <- melded_data_2013 %>%
  group_by(Start_Date, Lake_Code) %>%
  summarise(
    Taxa_Richness = n_distinct(Order),  # Count unique Orders per sample
    Shannon_Diversity = diversity(table(Order), index = "shannon"),  # Shannon-Wiener Index
    .groups = 'drop'
  )

# Merge the diversity indices back with environmental variables
melded_data_2013 <- melded_data_2013 %>%
  inner_join(taxa_data, by = c("Start_Date", "Lake_Code"))

# Checking the data structure
glimpse(melded_data_2013)

# Proceeding with the modeling part, using Taxa_Richness as a target variable
set.seed(15379)
banana_split <- initial_split(melded_data_2013, prop = 0.8)
choco_choochoo <- training(banana_split)
vanilla_ice_mic <- testing(banana_split)

# Specify a recipe to preprocess data
sundae_recipe <- recipe(Taxa_Richness ~ 
                          Start_Date + 
                          Veg_Cover + 
                          Temperature_C + 
                          Dissolved_oxygen + 
                          pH + 
                          Depth_m + 
                          Turbidity, 
                        data = choco_choochoo) %>%
  step_normalize(all_numeric_predictors())

# Specify the model
icecream_model <- rand_forest(mtry = tune(), trees = 250, min_n = 500) %>%
  set_engine("ranger") %>%
  set_mode("regression")

# Creating a workflow
icecream_scoop <- workflow() %>%
  add_model(icecream_model) %>%
  add_recipe(sundae_recipe)

# Cross-validation process
validated_process <- vfold_cv(vanilla_ice_mic, v = 5)

# Tuning the model
salt_to_taste <- tune_grid(
  icecream_scoop,
  resamples = validated_process,
  grid = 10
)

# Selecting the best model based on RMSE
best_flavor <- select_best(salt_to_taste, metric = "rmse")

# Finalizing the model
final_flavor <- finalize_model(icecream_model, best_flavor)

# Final workflow with the best model
final_flav_package <- icecream_scoop %>%
  finalize_workflow(best_flavor)

# Fitting the model to the training data
icecream_retail <- final_flav_package %>%
  fit(data = choco_choochoo)

# Making predictions on test data
public_tastes <- predict(icecream_retail, new_data = vanilla_ice_mic) %>%
  bind_cols(vanilla_ice_mic)

# Evaluating model performance using RMSE
parlor_review <- public_tastes %>%
  metrics(truth = Taxa_Richness, estimate = .pred)

# Visualizing the predictions vs actual Taxa Richness
ggplot(public_tastes, aes(x = Taxa_Richness, y = .pred)) + 
  geom_point(alpha = 0.5) + 
  geom_abline(linetype = "dashed", color = "blue") + 
  labs(x = "Actual Taxa Richness", y = "Predicted", title = "Predicted vs Actual Taxa Richness")
```

```{r}
# Load packages
library(dplyr)
library(ggplot2)
library(tidyr)
library(reshape2)

# ----- INSECT ORDER ABUNDANCE (2013 & 2019) -----

insect_order_counts_2013 <- melded_data_2013 %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  group_by(Order) %>%
  summarise(Total_Count = sum(Count, na.rm = TRUE)) %>%
  mutate(Year = 2013)

insect_order_counts_2019 <- melded_data_2019 %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  group_by(Order) %>%
  summarise(Total_Count = sum(Count, na.rm = TRUE)) %>%
  mutate(Year = 2019)

insect_order_counts_combined <- bind_rows(insect_order_counts_2013, insect_order_counts_2019)

ggplot(insect_order_counts_combined, aes(x = reorder(Order, -Total_Count), y = Total_Count, fill = factor(Year))) +
  geom_col(position = "dodge") +
  labs(
    title = "Total Insect Counts by Order: 2013 vs 2019 (Lassen Volcanic NP)",
    x = "Insect Order", y = "Total Count", fill = "Year"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# ----- RIPARIAN COVER CATEGORIES -----

barren_2013 <- merged_data_2013 %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  select(Barren_AreaCcover) %>%
  mutate(Year = 2013)

barren_2019 <- merged_data_2019 %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  select(Barren_AreaCcover) %>%
  mutate(Year = 2019)

barren_combined <- bind_rows(barren_2013, barren_2019)

ggplot(barren_combined, aes(x = Barren_AreaCcover, fill = factor(Year))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Riparian Cover Categories in Lassen Volcanic NP (2013 vs 2019)",
    x = "Riparian Cover Category", y = "Frequency", fill = "Year"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# ----- WATER QUALITY BOX PLOTS -----

water_quality_box <- bind_rows(
  melded_data_2013 %>% mutate(Year = "2013"),
  melded_data_2019 %>% mutate(Year = "2019")
) %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  select(Temperature_C, Dissolved_oxygen, pH, Year) %>%
  drop_na() %>%
  pivot_longer(cols = c(Temperature_C, Dissolved_oxygen, pH),
               names_to = "Metric", values_to = "Value")

ggplot(water_quality_box, aes(x = Year, y = Value, fill = Year)) +
  geom_boxplot(alpha = 0.7, outlier.color = "black") +
  facet_wrap(~ Metric, scales = "free_y") +
  labs(
    title = "Water Quality Metrics (Predictors of EPT Richness) in Lassen NP",
    x = "Year", y = "Measured Value"
  ) +
  scale_fill_manual(values = c("2013" = "blue", "2019" = "orange")) +
  theme_minimal() +
  theme(text = element_text(size = 13), legend.position = "none")


# ----- CORRELATION HEATMAP (WITH EPT RICHNESS) -----

# Calculate EPT richness
ept_rich_data <- bind_rows(melded_data_2013, melded_data_2019) %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  filter(Order %in% c("Ephemeroptera", "Plecoptera", "Trichoptera")) %>%
  group_by(Start_Date, Lake_Code) %>%
  summarise(EPT_Richness = n_distinct(Order), .groups = "drop")

# Join richness back to environmental data
cor_data_full <- bind_rows(
  melded_data_2013 %>% mutate(Year = "2013"),
  melded_data_2019 %>% mutate(Year = "2019")
) %>%
  filter(Park_Name == "Lassen Volcanic National Park") %>%
  group_by(Start_Date, Lake_Code) %>%
  slice(1) %>%
  ungroup() %>%
  left_join(ept_rich_data, by = c("Start_Date", "Lake_Code")) %>%
  select(Temperature_C, Dissolved_oxygen, pH, Veg_Cover, EPT_Richness) %>%
  drop_na()

# Compute correlation matrix
cor_matrix_full <- cor(cor_data_full, use = "complete.obs")
cor_melt_full <- melt(cor_matrix_full)

ggplot(cor_melt_full, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "red", high = "blue", mid = "white",
    midpoint = 0, limit = c(-1, 1),
    name = "Correlation"
  ) +
  labs(
    title = "Correlation Heatmap: EPT Richness and Environmental Variables",
    x = NULL, y = NULL
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
# Load Libraries
library(ggplot2)
library(dplyr)
library(tidymodels)
library(parsnip)
library(vegan)
library(tidyr)
library(reshape2)

# Load data
invert_species <- read.csv("InvertSpecies (5).csv")
riparian_cover <- read.csv("RiparianCover (3).csv")
water_quality <- read.csv("WaterQuality (2).csv")

# Filter for Lassen Volcanic National Park and years 2013 and 2019
invert_filtered <- invert_species %>%
  filter(Park_Name == "Lassen Volcanic National Park" &
           (as.Date(Start_Date) >= as.Date("2013-01-01") & as.Date(Start_Date) <= as.Date("2013-12-31") |
            as.Date(Start_Date) >= as.Date("2019-01-01") & as.Date(Start_Date) <= as.Date("2019-12-31")))

riparian_filtered <- riparian_cover %>%
  filter(Park_Name == "Lassen Volcanic National Park" &
           (as.Date(Start_Date) >= as.Date("2013-01-01") & as.Date(Start_Date) <= as.Date("2013-12-31") |
            as.Date(Start_Date) >= as.Date("2019-01-01") & as.Date(Start_Date) <= as.Date("2019-12-31")))

water_quality_filtered <- water_quality %>%
  filter(Park_Name == "Lassen Volcanic National Park" &
           (as.Date(Start_Date) >= as.Date("2013-01-01") & as.Date(Start_Date) <= as.Date("2013-12-31") |
            as.Date(Start_Date) >= as.Date("2019-01-01") & as.Date(Start_Date) <= as.Date("2019-12-31")))

# Merge datasets
merged_data <- invert_filtered %>%
  inner_join(riparian_filtered, by = c("Lake_Code", "Park_Name", "Start_Date")) %>%
  inner_join(water_quality_filtered, by = c("Lake_Code", "Park_Name", "Start_Date"))

# Add numeric riparian cover and convert Order
merged_data <- merged_data %>%
  mutate(
    Veg_Cover = case_when(
      Barren_AreaCcover == "sparse (<10%)" ~ 0.05,
      Barren_AreaCcover == "moderate (10-40%)" ~ 0.25,
      Barren_AreaCcover == "heavy (40-75%)" ~ 0.57,
      Barren_AreaCcover == "very heavy (>75%)" ~ 0.87),
    Order = as.factor(Order),
    Year = ifelse(as.Date(Start_Date) < as.Date("2014-01-01"), 2013, 2019)
  )

# Calculate Taxa Richness and Shannon Diversity
taxa_data <- merged_data %>%
  group_by(Start_Date, Lake_Code) %>%
  summarise(
    Taxa_Richness = n_distinct(Order),
    Shannon_Diversity = diversity(table(Order)),
    .groups = 'drop'
  )

# Join diversity metrics
merged_data <- merged_data %>%
  inner_join(taxa_data, by = c("Start_Date", "Lake_Code"))

# Split into 2013 and 2019 for visuals
melded_data_2013 <- merged_data %>% filter(Year == 2013)
melded_data_2019 <- merged_data %>% filter(Year == 2019)

# --- Modeling EPT Richness with environmental variables ---

set.seed(15379)
split_data <- initial_split(merged_data, prop = 0.8)
train_data <- training(split_data)
test_data <- testing(split_data)

recipe_model <- recipe(Taxa_Richness ~ Start_Date + Veg_Cover + Temperature_C + Dissolved_oxygen + pH + Depth_m + Turbidity, data = train_data) %>%
  step_normalize(all_numeric_predictors())

model_spec <- rand_forest(mtry = tune(), trees = 250, min_n = 500) %>%
  set_engine("ranger") %>%
  set_mode("regression")

workflow_model <- workflow() %>%
  add_model(model_spec) %>%
  add_recipe(recipe_model)

cv_folds <- vfold_cv(test_data, v = 5)

tune_results <- tune_grid(
  workflow_model,
  resamples = cv_folds,
  grid = 10
)

best_model <- select_best(tune_results, metric = "rmse")
final_model <- finalize_model(model_spec, best_model)
final_workflow <- workflow_model %>% finalize_workflow(best_model)

fitted_model <- final_workflow %>% fit(data = train_data)

predictions <- predict(fitted_model, new_data = test_data) %>%
  bind_cols(test_data)

predictions %>%
  metrics(truth = Taxa_Richness, estimate = .pred)

# --- Visualizations ---

# Insect Order Abundance
order_counts <- merged_data %>%
  group_by(Year, Order) %>%
  summarise(Total_Count = sum(Count, na.rm = TRUE), .groups = "drop")

ggplot(order_counts, aes(x = reorder(Order, -Total_Count), y = Total_Count, fill = factor(Year))) +
  geom_col(position = "dodge") +
  labs(title = "Total Insect Counts by Order: 2013 vs 2019", x = "Insect Order", y = "Total Count", fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Riparian Cover Categories
riparian_combined <- merged_data %>%
  select(Barren_AreaCcover, Year)

ggplot(riparian_combined, aes(x = Barren_AreaCcover, fill = factor(Year))) +
  geom_bar(position = "dodge") +
  labs(title = "Riparian Cover Categories in Lassen NP", x = "Cover Category", y = "Count", fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Water Quality Box Plots
water_quality_long <- merged_data %>%
  select(Temperature_C, Dissolved_oxygen, pH, Year) %>%
  drop_na() %>%
  pivot_longer(cols = c(Temperature_C, Dissolved_oxygen, pH), names_to = "Metric", values_to = "Value")

ggplot(water_quality_long, aes(x = factor(Year), y = Value, fill = factor(Year))) +
  geom_boxplot(alpha = 0.7) +
  facet_wrap(~ Metric, scales = "free_y") +
  labs(title = "Water Quality Metrics (2013 vs 2019)", x = "Year", y = "Value") +
  scale_fill_manual(values = c("2013" = "blue", "2019" = "orange")) +
  theme_minimal()

# Correlation Heatmap
ept_richness <- merged_data %>%
  filter(Order %in% c("Ephemeroptera", "Plecoptera", "Trichoptera")) %>%
  group_by(Start_Date, Lake_Code) %>%
  summarise(EPT_Richness = n_distinct(Order), .groups = "drop")

correlation_data <- merged_data %>%
  group_by(Start_Date, Lake_Code) %>%
  slice(1) %>%
  ungroup() %>%
  left_join(ept_richness, by = c("Start_Date", "Lake_Code")) %>%
  select(Temperature_C, Dissolved_oxygen, pH, Veg_Cover, EPT_Richness) %>%
  drop_na()

cor_matrix <- cor(correlation_data, use = "complete.obs")
cor_melt <- melt(cor_matrix)

ggplot(cor_melt, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "red", high = "blue", mid = "white",
                       midpoint = 0, limit = c(-1, 1), name = "Correlation") +
  labs(title = "Correlation Heatmap: EPT Richness and Environmental Variables") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Predicted vs Actual Plot
ggplot(predictions, aes(x = Taxa_Richness, y = .pred)) + 
  geom_point(alpha = 0.5) + 
  geom_abline(linetype = "dashed", color = "blue") + 
  labs(x = "Actual Taxa Richness", y = "Predicted", title = "Predicted vs Actual Taxa Richness")

```

